/*
 * charts for WeChat small app v1.0
 *
 * https://github.com/xiaolin3303/wx-charts
 * 2016-11-28
 *
 * Designed and built with all the love of Web
 */

"use strict";function assign(t,e){if(null==t)throw new TypeError("Cannot convert undefined or null to object");for(var i=Object(t),n=1;n<arguments.length;n++){var a=arguments[n];if(null!=a)for(var o in a)Object.prototype.hasOwnProperty.call(a,o)&&(i[o]=a[o])}return i}function findRange(t,e,i){i=i||10,e=e?e:"upper";for(var n=1;i<1;)i*=10,n*=10;for(t="upper"===e?Math.ceil(t*n):Math.floor(t*n);t%i!==0;)"upper"===e?t++:t--;return t/n}function fillSeriesColor(t,e){var i=0;return t.map(function(t){return t.color||(t.color=e.colors[i],i=(i+1)%e.colors.length),t})}function getDataRange(t,e){var i=0,n=e-t;return i=n>=1e4?1e3:n>=1e3?100:n>=100?10:n>=10?5:n>=1?1:n>=.1?.1:.01,{minRange:findRange(t,"lower",i),maxRange:findRange(e,"upper",i)}}function mesureText(t){t=String(t);var t=t.split(""),e=0;return t.forEach(function(t){e+=/[a-zA-Z]/.test(t)?7:/[0-9]/.test(t)?5.5:/\./.test(t)?2.7:/-/.test(t)?3.25:/[\u4e00-\u9fa5]/.test(t)?10:/\(|\)/.test(t)?3.73:/\s/.test(t)?2.5:10}),e}function dataCombine(t){return t.reduce(function(t,e){return(t.data?t.data:t).concat(e.data)},[])}function getPieDataPoints(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=0,n=0;return t.forEach(function(t){i+=t.data}),t.forEach(function(t){t._proportion_=t.data/i*e}),t.forEach(function(t){t._start_=n,n+=2*t._proportion_*Math.PI}),t}function fixColumeData(t,e,i,n,a){return t.map(function(t){return t.width=(e-2*a.columePadding)/i,t.x=t.x-e/2+a.columePadding+(n+.5)*t.width,t.width=Math.round(t.width),t.x=Math.round(t.x),t})}function getXAxisPoints(t,e,i){var n=i.yAxisWidth+i.yAxisTitleWidth,a=e.width-2*i.padding-n,o=Math.floor(a/t.length),r=[],s=i.padding+n,l=e.width-i.padding;return t.forEach(function(t,e){r.push(s+e*o)}),r.push(l),{xAxisPoints:r,startX:s,endX:l,eachSpacing:o}}function getDataPoints(t,e,i,n,a,o,r){var s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:1,l=[],d=o.height-2*r.padding-r.xAxisHeight-r.legendHeight;return t.forEach(function(t,h){var c={};c.x=n[h]+Math.round(a/2);var g=d*(t-e)/(i-e);g*=s,c.y=o.height-r.xAxisHeight-r.legendHeight-Math.round(g)-r.padding,l.push(c)}),l}function getYAxisTextList(t,e,i){for(var n=dataCombine(t),a="number"==typeof e.yAxis.min?e.yAxis.min:Math.min.apply(this,n),o=Math.max.apply(this,n),r=getDataRange(a,o),s=r.minRange,l=r.maxRange,d=[],h=(l-s)/i.yAxisSplit,c=0;c<=i.yAxisSplit;c++)d.push(s+h*c);return d.reverse()}function calYAxisData(t,e,i){var n=getYAxisTextList(t,e,i),a=i.yAxisWidth,o=n.map(function(t){return t=util.toFixed(t,2),t=e.yAxis.format?e.yAxis.format(Number(t)):t,a=Math.max(a,mesureText(t)+5),t});return{rangesFormat:o,ranges:n,yAxisWidth:a}}function drawPointShape(t,e,i,n){n.beginPath(),n.setStrokeStyle("#ffffff"),n.setLineWidth(1),n.setFillStyle(e),"diamond"===i?t.forEach(function(t,e){n.moveTo(t.x,t.y-4.5),n.lineTo(t.x-4.5,t.y),n.lineTo(t.x,t.y+4.5),n.lineTo(t.x+4.5,t.y),n.lineTo(t.x,t.y-4.5)}):"circle"===i?t.forEach(function(t,e){n.moveTo(t.x+3.5,t.y),n.arc(t.x,t.y,4,0,2*Math.PI,!1)}):"rect"===i?t.forEach(function(t,e){n.moveTo(t.x-3.5,t.y-3.5),n.rect(t.x-3.5,t.y-3.5,7,7)}):"triangle"===i&&t.forEach(function(t,e){n.moveTo(t.x,t.y-4.5),n.lineTo(t.x-4.5,t.y+4.5),n.lineTo(t.x+4.5,t.y+4.5),n.lineTo(t.x,t.y-4.5)}),n.closePath(),n.fill(),n.stroke()}function drawPointText(t,e,i,n){var a=e.data;n.beginPath(),n.setFontSize(i.fontSize),n.setFillStyle("#666666"),t.forEach(function(t,i){var o=e.format?e.format(a[i]):a[i];n.fillText(o,t.x-mesureText(o)/2,t.y-2)}),n.closePath(),n.stroke()}function drawYAxisTitle(t,e,i,n){var a=i.xAxisHeight+(e.height-i.xAxisHeight-mesureText(t))/2;n.save(),n.beginPath(),n.setFontSize(i.fontSize),n.setFillStyle("#333333"),n.translate(0,e.height),n.rotate(-90*Math.PI/180),n.fillText(t,a,i.padding+.5*i.fontSize),n.stroke(),n.closePath(),n.restore()}function drawColumnDataPoints(t,e,i,n){var a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,o=calYAxisData(t,e,i),r=o.ranges,s=getXAxisPoints(e.categories,e,i),l=s.xAxisPoints,d=s.eachSpacing,h=r.pop(),c=r.shift();e.height-i.padding-i.xAxisHeight-i.legendHeight;t.forEach(function(o,r){var s=o.data,g=getDataPoints(s,h,c,l,d,e,i,a);g=fixColumeData(g,d,t.length,r,i),n.beginPath(),n.setFillStyle(o.color),g.forEach(function(t,a){var o=t.x-t.width/2+1,r=e.height-t.y-i.padding-i.xAxisHeight-i.legendHeight;n.moveTo(o,t.y),n.rect(o,t.y,t.width-2,r)}),n.closePath(),n.fill()}),t.forEach(function(o,r){var s=o.data,g=getDataPoints(s,h,c,l,d,e,i,a);g=fixColumeData(g,d,t.length,r,i),e.dataLabel!==!1&&1===a&&drawPointText(g,o,i,n)})}function drawAreaDataPoints(t,e,i,n){var a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,o=calYAxisData(t,e,i),r=o.ranges,s=getXAxisPoints(e.categories,e,i),l=s.xAxisPoints,d=s.eachSpacing,h=r.pop(),c=r.shift(),g=e.height-i.padding-i.xAxisHeight-i.legendHeight;t.forEach(function(t,o){var r=t.data,s=getDataPoints(r,h,c,l,d,e,i,a),f=s[0],u=s[s.length-1];n.beginPath(),n.setStrokeStyle(t.color),n.setFillStyle(t.color),n.setGlobalAlpha(.6),n.setLineWidth(2),n.moveTo(f.x,f.y),s.forEach(function(t,e){e>0&&n.lineTo(t.x,t.y)}),n.lineTo(u.x,g),n.lineTo(f.x,g),n.lineTo(f.x,f.y),n.closePath(),n.fill(),n.setGlobalAlpha(1);var x=i.dataPointShape[o%i.dataPointShape.length];drawPointShape(s,t.color,x,n)}),e.dataLabel!==!1&&1===a&&t.forEach(function(t,o){var r=t.data,s=getDataPoints(r,h,c,l,d,e,i,a);drawPointText(s,t,i,n)})}function drawLineDataPoints(t,e,i,n){var a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,o=calYAxisData(t,e,i),r=o.ranges,s=getXAxisPoints(e.categories,e,i),l=s.xAxisPoints,d=s.eachSpacing,h=r.pop(),c=r.shift();t.forEach(function(t,o){var r=t.data,s=getDataPoints(r,h,c,l,d,e,i,a);n.beginPath(),n.setStrokeStyle(t.color),n.setLineWidth(2),n.moveTo(s[0].x,s[0].y),s.forEach(function(t,e){e>0&&n.lineTo(t.x,t.y)}),n.moveTo(s[0].x,s[0].y),n.closePath(),n.stroke();var g=i.dataPointShape[o%i.dataPointShape.length];drawPointShape(s,t.color,g,n)}),e.dataLabel!==!1&&1===a&&t.forEach(function(t,o){var r=t.data,s=getDataPoints(r,h,c,l,d,e,i,a);drawPointText(s,t,i,n)})}function drawXAxis(t,e,i,n){var a=getXAxisPoints(t,e,i),o=a.xAxisPoints,r=a.startX,s=a.endX,l=a.eachSpacing,d=e.height-i.padding-i.xAxisHeight-i.legendHeight,h=e.height-i.padding-i.legendHeight;n.beginPath(),n.setStrokeStyle("#cccccc"),n.setLineWidth(1),n.moveTo(r,d),n.lineTo(s,d),o.forEach(function(t,e){n.moveTo(t,d),n.lineTo(t,h)}),n.closePath(),n.stroke(),n.beginPath(),n.setFontSize(i.fontSize),n.setFillStyle("#666666"),t.forEach(function(t,e){var a=l/2-mesureText(t)/2;n.fillText(t,o[e]+a,d+i.fontSize+5)}),n.closePath(),n.stroke()}function drawYAxis(t,e,i,n){for(var a=calYAxisData(t,e,i),o=a.rangesFormat,r=i.yAxisWidth+i.yAxisTitleWidth,s=e.height-2*i.padding-i.xAxisHeight-i.legendHeight,l=Math.floor(s/i.yAxisSplit),d=i.padding+r,h=e.width-i.padding,c=(i.padding,e.height-i.padding-i.xAxisHeight-i.legendHeight),g=[],f=0;f<i.yAxisSplit;f++)g.push(i.padding+l*f);n.beginPath(),n.setStrokeStyle("#cccccc"),n.setLineWidth(1),g.forEach(function(t,e){n.moveTo(d,t),n.lineTo(h,t)}),n.closePath(),n.stroke(),n.beginPath(),n.setFontSize(i.fontSize),n.setFillStyle("#666666"),o.forEach(function(t,e){var a=g[e]?g[e]:c;n.fillText(t,i.padding+i.yAxisTitleWidth,a+10)}),n.closePath(),n.stroke(),e.yAxis.title&&drawYAxisTitle(e.yAxis.title,e,i,n)}function drawLegend(t,e,i,n){if(e.legend){var a=5,o=0;t.forEach(function(t){t.name=t.name||"undefined",o+=2*a+mesureText(t.name)+22.5});var r=(e.width-o)/2+a,s=e.height-i.legendHeight-5;n.setFontSize(i.fontSize),t.forEach(function(t){n.moveTo(r,s),n.beginPath(),n.setFillStyle(t.color),n.rect(r,s,15,10),n.closePath(),n.fill(),r+=a+15,n.beginPath(),n.setFillStyle("#333333"),n.fillText(t.name,r,s+9),n.closePath(),n.stroke(),r+=mesureText(t.name)+a+7.5})}}function drawPieDataPoints(t,e,i,n){var a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;t=getPieDataPoints(t,a);var o={x:e.width/2,y:(e.height-2*i.padding-i.legendHeight)/2+i.padding},r=Math.min(o.x-i.padding,o.y-2*i.padding);t.forEach(function(t){n.beginPath(),n.setLineWidth(2),n.setStrokeStyle("#ffffff"),n.setFillStyle(t.color),n.moveTo(o.x,o.y),n.arc(o.x,o.y,r,t._start_,2*t._proportion_*Math.PI),n.closePath(),n.fill(),n.stroke()}),"ring"===e.type&&(n.beginPath(),n.setFillStyle("#ffffff"),n.moveTo(o.x,o.y),n.arc(o.x,o.y,.6*r,0,2*Math.PI),n.closePath(),n.fill())}function drawCanvas(t,e){wx.drawCanvas({canvasId:t.canvasId,actions:e.getActions()})}function Animation(t){function e(n){if(null===i&&(i=n),n-i<t.duration){var a=(n-i)/t.duration,o=Timing[t.timing];a=o(a),t.onProcess&&t.onProcess(a),requestAnimationFrame(e)}else t.onProcess&&t.onProcess(1),t.onAnimationFinish&&t.onAnimationFinish()}t.duration="undefined"==typeof t.duration?1e3:t.duration,t.timing=t.timing||"linear";var i=null;requestAnimationFrame(e)}function drawCharts(t,e,i,n){var a=e.series,o=e.categories;a=fillSeriesColor(a,i);var r=calYAxisData(a,e,i),s=r.yAxisWidth;i.yAxisWidth=s;var l=e.animation?1e3:0;switch(t){case"line":Animation({timing:"easeIn",duration:l,onProcess:function(t){drawYAxis(a,e,i,n),drawXAxis(o,e,i,n),drawLineDataPoints(a,e,i,n,t),drawLegend(e.series,e,i,n),drawCanvas(e,n)}});break;case"column":Animation({timing:"easeIn",duration:l,onProcess:function(t){drawYAxis(a,e,i,n),drawXAxis(o,e,i,n),drawColumnDataPoints(a,e,i,n,t),drawLegend(e.series,e,i,n),drawCanvas(e,n)}});break;case"area":Animation({timing:"easeIn",duration:l,onProcess:function(t){drawYAxis(a,e,i,n),drawXAxis(o,e,i,n),drawAreaDataPoints(a,e,i,n,t),drawLegend(e.series,e,i,n),drawCanvas(e,n)}});break;case"ring":case"pie":Animation({timing:"easeInOut",duration:l,onProcess:function(t){drawPieDataPoints(a,e,i,n,t),drawLegend(e.series,e,i,n),drawCanvas(e,n)}})}}var config={yAxisWidth:15,yAxisSplit:5,xAxisHeight:15,legendHeight:15,yAxisTitleWidth:15,padding:12,columePadding:10,fontSize:10,dataPointShape:["diamond","circle","triangle","rect"],colors:["#7cb5ec","#f7a35c","#434348","#90ed7d","#f15c80","#8085e9"]},util={toFixed:function(t,e){return e=e||2,this.isFloat(t)&&(t=t.toFixed(e)),t},isFloat:function(t){return t%1!==0}},Timing={easeIn:function(t){return Math.pow(t,3)},easeOut:function(t){return Math.pow(t-1,3)+1},easeInOut:function(t){return(t/=.5)<1?.5*Math.pow(t,3):.5*(Math.pow(t-2,3)+2)},linear:function(t){return t}},Charts=function(t){t.yAxis=t.yAxis||{},t.legend=t.legend!==!1,t.animation=t.animation!==!1;var e=assign({},config);e.legendHeight=t.legend?e.legendHeight:0,e.yAxisTitleWidth=t.yAxis.title?e.yAxisTitleWidth:0;var i=wx.createContext();drawCharts(t.type,t,e,i)};module.exports=Charts;
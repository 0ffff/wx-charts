/*
 * charts for WeChat small app v1.0
 *
 * Contact: https://github.com/xiaolin3303
 * 2016-11-28
 *
 * Designed and built with all the love of Web
 */
"use strict";function assign(t,e){if(null==t)throw new TypeError("Cannot convert undefined or null to object");for(var i=Object(t),a=1;a<arguments.length;a++){var n=arguments[a];if(null!=n)for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(i[o]=n[o])}return i}function findRange(t,e,i){i=i||10,e=e?e:"upper";for(var a=1;i<1;)i*=10,a*=10;for(t="upper"===e?Math.ceil(t*a):Math.floor(t*a);t%i!==0;)"upper"===e?t++:t--;return t/a}function fillSeriesColor(t,e){var i=0;return t.map(function(t){return t.color||(t.color=e.colors[i],i=(i+1)%e.colors.length),t})}function getDataRange(t,e){var i=0,a=e-t;return i=a>=1e4?1e3:a>=1e3?100:a>=100?10:a>=10?5:a>=1?1:a>=.1?.1:.01,{minRange:findRange(t,"lower",i),maxRange:findRange(e,"upper",i)}}function mesureText(t){t=String(t);var t=t.split(""),e=0;return t.forEach(function(t){e+=/[a-zA-Z]/.test(t)?14:/[0-9]/.test(t)?11:/\./.test(t)?5.4:/-/.test(t)?6.5:/[\u4e00-\u9fa5]/.test(t)?20:/\(|\)/.test(t)?7.45:/\s/.test(t)?5:20}),e}function dataCombine(t){return t.reduce(function(t,e){return(t.data?t.data:t).concat(e.data)},[])}function getPieDataPoints(t){var e=0,i=0;return t.forEach(function(t){e+=t.data}),t.forEach(function(t){t._proportion_=t.data/e}),t.forEach(function(t){t._start_=i,i+=2*t._proportion_*Math.PI}),t}function fixColumeData(t,e,i,a,n){return t.map(function(t){return t.width=(e-2*n.columePadding)/i,t.x=t.x-e/2+n.columePadding+(a+.5)*t.width,t.width=Math.round(t.width),t.x=Math.round(t.x),t})}function getXAxisPoints(t,e,i){var a=i.yAxisWidth+i.yAxisTitleWidth,n=e.width-2*i.padding-a,o=Math.floor(n/t.length),r=[],s=i.padding+a,l=e.width-i.padding;return t.forEach(function(t,e){r.push(s+e*o)}),r.push(l),{xAxisPoints:r,startX:s,endX:l,eachSpacing:o}}function getDataPoints(t,e,i,a,n,o,r){var s=[],l=o.height-2*r.padding-r.xAxisHeight-r.legendHeight;return t.forEach(function(t,h){var c={};c.x=a[h]+Math.round(n/2);var d=l*(t-e)/(i-e);c.y=o.height-r.xAxisHeight-r.legendHeight-Math.round(d)-r.padding,s.push(c)}),s}function getYAxisTextList(t,e,i){for(var a=dataCombine(t),n="number"==typeof e.yAxis.min?e.yAxis.min:Math.min.apply(this,a),o=Math.max.apply(this,a),r=getDataRange(n,o),s=r.minRange,l=r.maxRange,h=[],c=(l-s)/i.yAxisSplit,d=0;d<=i.yAxisSplit;d++)h.push(s+c*d);return h.reverse()}function calYAxisData(t,e,i){var a=getYAxisTextList(t,e,i),n=i.yAxisWidth,o=a.map(function(t){return t=util.toFixed(t,2),t=e.yAxis.format?e.yAxis.format(Number(t)):t,n=Math.max(n,mesureText(t)+5),t});return{rangesFormat:o,ranges:a,yAxisWidth:n}}function drawPointShape(t,e,i,a){a.beginPath(),a.setStrokeStyle("#ffffff"),a.setLineWidth(2),a.setFillStyle(e),"diamond"===i?t.forEach(function(t,e){a.moveTo(t.x,t.y-9),a.lineTo(t.x-9,t.y),a.lineTo(t.x,t.y+9),a.lineTo(t.x+9,t.y),a.lineTo(t.x,t.y-9)}):"circle"===i?t.forEach(function(t,e){a.moveTo(t.x+7,t.y),a.arc(t.x,t.y,8,0,2*Math.PI,!1)}):"rect"===i?t.forEach(function(t,e){a.moveTo(t.x-7,t.y-7),a.rect(t.x-7,t.y-7,14,14)}):"triangle"===i&&t.forEach(function(t,e){a.moveTo(t.x,t.y-9),a.lineTo(t.x-9,t.y+9),a.lineTo(t.x+9,t.y+9),a.lineTo(t.x,t.y-9)}),a.closePath(),a.fill(),a.stroke()}function drawPointText(t,e,i,a){var n=e.data;a.beginPath(),a.setFontSize(i.fontSize),a.setFillStyle("#666666"),t.forEach(function(t,i){var o=e.format?e.format(n[i]):n[i];a.fillText(o,t.x-mesureText(o)/2,t.y-10)}),a.closePath(),a.stroke()}function drawYAxisTitle(t,e,i,a){var n=i.xAxisHeight+(e.height-i.xAxisHeight-mesureText(t))/2;a.save(),a.beginPath(),a.setFontSize(20),a.setFillStyle("#333333"),a.translate(0,e.height),a.rotate(-90*Math.PI/180),a.fillText(t,n,35),a.stroke(),a.closePath(),a.restore()}function drawColumnDataPoints(t,e,i,a){var n=calYAxisData(t,e,i),o=n.ranges,r=getXAxisPoints(e.categories,e,i),s=r.xAxisPoints,l=r.eachSpacing,h=o.pop(),c=o.shift();e.height-i.padding-i.xAxisHeight-i.legendHeight;t.forEach(function(n,o){var r=n.data,d=getDataPoints(r,h,c,s,l,e,i);d=fixColumeData(d,l,t.length,o,i),a.beginPath(),a.setFillStyle(n.color),d.forEach(function(t,n){var o=t.x-t.width/2+1,r=e.height-t.y-i.padding-i.xAxisHeight-i.legendHeight;a.moveTo(o,t.y),a.rect(o,t.y,t.width-2,r)}),a.closePath(),a.fill()}),t.forEach(function(a,n){var o=a.data,r=getDataPoints(o,h,c,s,l,e,i);r=fixColumeData(r,l,t.length,n,i),e.dataLabel!==!1&&drawPointText(r,a)})}function drawAreaDataPoints(t,e,i,a){var n=calYAxisData(t,e,i),o=n.ranges,r=getXAxisPoints(e.categories,e,i),s=r.xAxisPoints,l=r.eachSpacing,h=o.pop(),c=o.shift(),d=e.height-i.padding-i.xAxisHeight-i.legendHeight;t.forEach(function(t,n){var o=t.data,r=getDataPoints(o,h,c,s,l,e,i),g=r[0],x=r[r.length-1];a.beginPath(),a.setStrokeStyle(t.color),a.setFillStyle(t.color),a.setGlobalAlpha(.6),a.setLineWidth(4),a.moveTo(g.x,g.y),r.forEach(function(t,e){e>0&&a.lineTo(t.x,t.y)}),a.lineTo(x.x,d),a.lineTo(g.x,d),a.lineTo(g.x,g.y),a.closePath(),a.fill(),a.setGlobalAlpha(1);var f=i.dataPointShape[n%i.dataPointShape.length];drawPointShape(r,t.color,f,a)}),e.dataLabel!==!1&&t.forEach(function(t,n){var o=t.data,r=getDataPoints(o,h,c,s,l,e,i);drawPointText(r,t,i,a)})}function drawLineDataPoints(t,e,i,a){var n=calYAxisData(t,e,i),o=n.ranges,r=getXAxisPoints(e.categories,e,i),s=r.xAxisPoints,l=r.eachSpacing,h=o.pop(),c=o.shift();t.forEach(function(t,n){var o=t.data,r=getDataPoints(o,h,c,s,l,e,i);a.beginPath(),a.setStrokeStyle(t.color),a.setLineWidth(4),a.moveTo(r[0].x,r[0].y),r.forEach(function(t,e){e>0&&a.lineTo(t.x,t.y)}),a.moveTo(r[0].x,r[0].y),a.closePath(),a.stroke();var d=i.dataPointShape[n%i.dataPointShape.length];drawPointShape(r,t.color,d,a)}),e.dataLabel!==!1&&t.forEach(function(t,n){var o=t.data,r=getDataPoints(o,h,c,s,l,e,i);drawPointText(r,t,i,a)})}function drawXAxis(t,e,i,a){var n=getXAxisPoints(t,e,i),o=n.xAxisPoints,r=n.startX,s=n.endX,l=n.eachSpacing,h=e.height-i.padding-i.xAxisHeight-i.legendHeight,c=e.height-i.padding-i.legendHeight;a.beginPath(),a.setStrokeStyle("#cccccc"),a.setLineWidth(1),a.moveTo(r,h),a.lineTo(s,h),o.forEach(function(t,e){a.moveTo(t,h),a.lineTo(t,c)}),a.closePath(),a.stroke(),a.beginPath(),a.setFontSize(i.fontSize),a.setFillStyle("#666666"),t.forEach(function(t,e){var i=l/2-mesureText(t)/2;a.fillText(t,o[e]+i,h+28)}),a.closePath(),a.stroke()}function drawYAxis(t,e,i,a){for(var n=calYAxisData(t,e,i),o=n.rangesFormat,r=i.yAxisWidth+i.yAxisTitleWidth,s=e.height-2*i.padding-i.xAxisHeight-i.legendHeight,l=Math.floor(s/i.yAxisSplit),h=i.padding+r,c=e.width-i.padding,d=(i.padding,e.height-i.padding-i.xAxisHeight-i.legendHeight),g=[],x=0;x<i.yAxisSplit;x++)g.push(i.padding+l*x);a.beginPath(),a.setStrokeStyle("#cccccc"),a.setLineWidth(1),g.forEach(function(t,e){a.moveTo(h,t),a.lineTo(c,t)}),a.closePath(),a.stroke(),a.beginPath(),a.setFontSize(i.fontSize),a.setFillStyle("#666666"),o.forEach(function(t,e){var n=g[e]?g[e]:d;a.fillText(t,i.padding+i.yAxisTitleWidth,n+10)}),a.closePath(),a.stroke(),e.yAxis.title&&drawYAxisTitle(e.yAxis.title,e,i,a)}function drawLegend(t,e,i,a){if(e.legend){var n=10,o=0;t.forEach(function(t){t.name=t.name||"undefined",o+=2*n+mesureText(t.name)+45});var r=(e.width-o)/2+n,s=e.height-i.legendHeight-5;a.setFontSize(i.fontSize),t.forEach(function(t){a.moveTo(r,s),a.beginPath(),a.setFillStyle(t.color),a.rect(r,s,30,20),a.closePath(),a.fill(),r+=n+30,a.beginPath(),a.setFillStyle("#333333"),a.fillText(t.name,r,s+18),a.closePath(),a.stroke(),r+=mesureText(t.name)+n+15})}}function drawPieDataPoints(t,e,i,a){t=getPieDataPoints(t);var n={x:e.width/2,y:(e.height-2*i.padding-i.legendHeight)/2},o=Math.min(n.x-i.padding,n.y);a.setStrokeStyle("#ffffff"),a.setLineWidth(2),t.forEach(function(t){a.beginPath(),a.setFillStyle(t.color),a.moveTo(n.x,n.y),a.arc(n.x,n.y,o,t._start_,2*t._proportion_*Math.PI),a.closePath(),a.fill(),a.beginPath(),a.moveTo(n.x,n.y),a.arc(n.x,n.y,o,t._start_,0),a.lineTo(n.x,n.y),a.stroke(),a.closePath(),a.stroke(),a.beginPath(),a.moveTo(n.x,n.y),a.arc(n.x,n.y,o,t._start_+2*t._proportion_*Math.PI,0),a.moveTo(n.x,n.y),a.stroke(),a.closePath()})}function drawCanvas(t,e){wx.drawCanvas({canvasId:t.canvasId,actions:e.getActions()})}function drawCharts(t,e,i,a){var n=e.series,o=e.categories;n=fillSeriesColor(n,i);var r=calYAxisData(n,e,i),s=r.yAxisWidth;switch(i.yAxisWidth=s,t){case"line":drawYAxis(n,e,i,a),drawXAxis(o,e,i,a),drawLineDataPoints(n,e,i,a);break;case"column":drawYAxis(n,e,i,a),drawXAxis(o,e,i,a),drawColumnDataPoints(n,e,i,a);break;case"area":drawYAxis(n,e,i,a),drawXAxis(o,e,i,a),drawAreaDataPoints(n,e,i,a);break;case"pie":drawPieDataPoints(n,e,i,a)}}var config={yAxisWidth:30,yAxisSplit:5,xAxisHeight:30,legendHeight:30,yAxisTitleWidth:30,padding:30,columePadding:20,fontSize:20,dataPointShape:["diamond","circle","triangle","rect"],colors:["#7cb5ec","#f7a35c","#434348","#90ed7d","#f15c80","#8085e9"]},util={toFixed:function(t,e){return e=e||2,this.isFloat(t)&&(t=t.toFixed(e)),t},isFloat:function(t){return t%1!==0}},Charts=function(t){t.yAxis=t.yAxis||{},t.legend=t.legend!==!1;var e=assign({},config);e.legendHeight=t.legend?30:0,e.yAxisTitleWidth=t.yAxis.title?30:0;var i=wx.createContext();drawCharts(t.type,t,e,i),drawLegend(t.series,t,e,i),drawCanvas(t,i)};module.exports=Charts;
